@echo off
setlocal

:: 設定要檢查的 port
set PORT=8501
:: 設定要執行的 Python 檔案
set PYTHON_SCRIPT=app_launcher.py
:: 設定 Python 檔案所在的目錄
set WORKING_DIR=F:\LLM_sample\buscard
:: 設定虛擬環境路徑
set VENV_DIR=%WORKING_DIR%\venv

:: 切換到指定工作目錄
cd /d "%WORKING_DIR%"
if %ERRORLEVEL% neq 0 (
    echo Failed to change directory to %WORKING_DIR%.
    exit /b 1
)

:: 啟動虛擬環境
if exist "%VENV_DIR%\Scripts\activate.bat" (
    call "%VENV_DIR%\Scripts\activate.bat"
    if %ERRORLEVEL% neq 0 (
        echo Failed to activate virtual environment.
        exit /b 1
    )
) else (
    echo Virtual environment not found at %VENV_DIR%.
    exit /b 1
)

:: 檢查 port 是否在 listen 狀態
netstat -an | findstr /i ":%PORT%.*LISTEN" > nul
if %ERRORLEVEL% equ 0 (
    echo Port %PORT% is already in use.
    exit /b 1
) else (
    echo Port %PORT% is free, starting Python script...
    "%VENV_DIR%\Scripts\python.exe" "%PYTHON_SCRIPT%"
    if %ERRORLEVEL% neq 0 (
        echo Failed to run Python script.
        exit /b 1
    )
)

echo Python script executed successfully.
endlocal
pause
